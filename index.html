<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Симулятор Магазина</title>
<style>
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif;
    background: #f0f0f0;
    display: flex; flex-direction: column; align-items: center;
  }
  #startScreen, #gameScreen {
    width: 100%; max-width: 480px;
    padding: 20px;
    box-sizing: border-box;
  }
  #startScreen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100vh;
  }
  #startScreen input {
    padding: 10px;
    font-size: 18px;
    width: 80%;
    margin-bottom: 10px;
  }
  #startScreen button {
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
  }

  #header {
    background: #4a90e2;
    color: white;
    padding: 10px 20px;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
  }
  #header h1 {
    margin: 0;
  }
  #header .rating {
    margin-top: 4px;
    font-size: 16px;
  }

  #balance {
    margin: 15px 0;
    font-size: 20px;
    text-align: center;
  }

  #products, #storage {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  .product, .storage-item {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    padding: 10px;
    width: 140px;
    box-sizing: border-box;
    text-align: center;
  }
  .product button, .storage-item button {
    margin-top: 8px;
    padding: 5px 10px;
    font-size: 14px;
    cursor: pointer;
  }

  #storage {
    margin-top: 20px;
  }

  #upgradeSection {
    margin: 20px 0;
    text-align: center;
  }
  #upgradeSection button {
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
  }

  #reviews {
    margin-top: 20px;
    max-height: 150px;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    padding: 10px;
    box-sizing: border-box;
  }
  #reviews .review {
    border-bottom: 1px solid #ddd;
    padding: 5px 0;
    font-size: 14px;
  }
  #reviews .review:last-child {
    border-bottom: none;
  }
  .stars {
    color: #f5a623;
  }
</style>
</head>
<body>

<div id="startScreen">
  <h2>Введите название вашего магазина</h2>
  <input type="text" id="shopNameInput" placeholder="Название магазина" maxlength="20" />
  <button id="startBtn">Начать</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="header">
    <h1 id="shopName">Магазин</h1>
    <div class="rating">Рейтинг: <span id="ratingValue">—</span></div>
  </div>

  <div id="balance">Баланс: <span id="balanceValue">50</span> монет</div>

  <h3>Товары для покупки</h3>
  <div id="products"></div>

  <h3>Склад (вместимость <span id="storageCapacity">10</span>)</h3>
  <div id="storage"></div>

  <div id="upgradeSection">
    <button id="upgradeStorageBtn">Улучшить склад (цена: <span id="upgradePrice">100</span> монет)</button>
  </div>

  <h3>Отзывы покупателей</h3>
  <div id="reviews"></div>
</div>

<script>
(() => {
  // --- Данные ---
  const productsData = [
    {id: 'apple', name: 'Яблоко', price: 50},
    {id: 'orange', name: 'Апельсин', price: 50},
    {id: 'coconut', name: 'Кокос', price: 50},
    {id: 'ramen', name: 'Рамен', price: 50},
    {id: 'banana', name: 'Банан', price: 50},
    {id: 'bread', name: 'Хлеб', price: 50},
    {id: 'milk', name: 'Молоко', price: 50},
    {id: 'cheese', name: 'Сыр', price: 50},
    {id: 'fish', name: 'Рыба', price: 50},
    {id: 'egg', name: 'Яйцо', price: 50},
  ];

  let balance = 50;
  let storageCapacity = 10;
  let upgradePrice = 100;
  let storage = {}; // id -> {count, price}
  let reviews = []; // последние 10 отзывов

  let shopName = 'Магазин';

  // --- Элементы ---
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const shopNameElem = document.getElementById('shopName');
  const ratingValueElem = document.getElementById('ratingValue');
  const balanceValueElem = document.getElementById('balanceValue');
  const productsElem = document.getElementById('products');
  const storageElem = document.getElementById('storage');
  const storageCapacityElem = document.getElementById('storageCapacity');
  const upgradePriceElem = document.getElementById('upgradePrice');
  const upgradeStorageBtn = document.getElementById('upgradeStorageBtn');
  const reviewsElem = document.getElementById('reviews');
  const shopNameInput = document.getElementById('shopNameInput');
  const startBtn = document.getElementById('startBtn');

  // --- Функции ---
  function renderProducts() {
    productsElem.innerHTML = '';
    productsData.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <strong>${p.name}</strong><br/>
        Цена покупки: <strong>5</strong> монет<br/>
        Цена продажи (установленная): <input type="number" min="10" max="50" value="${storage[p.id]?.price ?? 50}" data-id="${p.id}" style="width: 60px;" /> <br/>
        <button data-id="${p.id}">Купить</button>
      `;
      productsElem.appendChild(div);
    });
  }

  function renderStorage() {
    storageElem.innerHTML = '';
    const keys = Object.keys(storage);
    if(keys.length === 0) {
      storageElem.innerHTML = '<i>Склад пуст</i>';
      return;
    }
    keys.forEach(id => {
      const item = storage[id];
      const div = document.createElement('div');
      div.className = 'storage-item';
      div.innerHTML = `
        <strong>${productsData.find(p => p.id === id).name}</strong><br/>
        Количество: ${item.count}<br/>
        Цена продажи: ${item.price} монет<br/>
        <button data-id="${id}">Продать</button>
      `;
      storageElem.appendChild(div);
    });
  }

  function renderBalance() {
    balanceValueElem.textContent = balance;
  }

  function renderStorageCapacity() {
    storageCapacityElem.textContent = storageCapacity;
  }

  function renderUpgradePrice() {
    upgradePriceElem.textContent = upgradePrice;
  }

  function renderReviews() {
    reviewsElem.innerHTML = '';
    if(reviews.length === 0) {
      reviewsElem.innerHTML = '<i>Отзывов пока нет</i>';
      return;
    }
    reviews.forEach(r => {
      const div = document.createElement('div');
      div.className = 'review';
      div.innerHTML = `<span class="stars">${'★'.repeat(r.stars)}${'☆'.repeat(5-r.stars)}</span> — ${r.text}`;
      reviewsElem.appendChild(div);
    });
  }

  // Подсчет рейтинга (среднее по последним 10 отзывам)
  function calculateRating() {
    if(reviews.length === 0) return '—';
    const sum = reviews.reduce((a,b) => a + b.stars, 0);
    return (sum / reviews.length).toFixed(1);
  }

  // Добавить отзыв, с ограничением до 10 последних
  function addReview(stars, text) {
    reviews.push({stars, text});
    if(reviews.length > 10) reviews.shift();
    renderReviews();
    ratingValueElem.textContent = calculateRating();
  }

  // Подсчитать общий занятый склад
  function storageCount() {
    return Object.values(storage).reduce((a,b) => a + b.count, 0);
  }

  // Проверка проигрыша: если монет 0 и склад пуст
  function checkLose() {
    if(balance <= 0 && storageCount() === 0) {
      alert('Вы проиграли! Игра будет перезапущена.');
      location.reload();
    }
  }

  // Обработка покупки товара (фиксировано 5 монет за покупку)
  function buyProduct(id) {
    if(balance < 5) {
      alert('Недостаточно монет для покупки (нужно 5).');
      return;
    }
    if(storageCount() >= storageCapacity) {
      alert('Склад переполнен, сделайте апгрейд или продайте товары.');
      return;
    }
    balance -= 5;
    if(storage[id]) {
      storage[id].count++;
    } else {
      storage[id] = {count:1, price: 50};
    }
    renderBalance();
    renderStorage();
  }

  // Продажа товара:  
  // Цена продажи зависит от установленной цены на товар в складе  
  // Чем ближе цена к 10, тем лучше отзыв и выше шанс продажи  
  function sellProduct(id) {
    if(!storage[id] || storage[id].count === 0) {
      alert('Товар отсутствует на складе.');
      return;
    }

    const price = storage[id].price;
    if(price < 10) storage[id].price = 10;
    if(price > 50) storage[id].price = 50;

    // Спрос зависит от цены:  
    // вероятность продажи = 1 - (цена-10)/40 (от 1 при цене 10 до 0 при цене 50)  
    const saleChance = 1 - (price - 10) / 40;
    if(Math.random() > saleChance) {
      // покупатель не купил — плохой отзыв  
      addReview(1, `Слишком дорогой ${productsData.find(p => p.id === id).name}.`);
      alert('Покупатель посчитал цену слишком высокой и не купил товар.');
      return;
    }

    // Успешная продажа
    storage[id].count--;
    balance += price;

    // Отзыв в зависимости от цены:  
    // цена ближе к 10 — 5 звёзд, ближе к 50 — 1 звезда (линейно)  
    const stars = Math.round(5 - ((price - 10) / 40) * 4);
    const positiveComments = [
      'Отличный товар!',
      'Очень доволен покупкой!',
      'Хорошее качество.',
      'Цена адекватная, покупаю ещё.',
      'Буду рекомендовать друзьям.'
    ];
    const negativeComments = [
      'Слишком дорого.',
      'Не стоит своих денег.',
      'Покупать не рекомендую.',
      'Цена завышена.',
      'Ждал скидок, но нет.'
    ];

    const text = stars >= 4 ? positiveComments[Math.floor(Math.random()*positiveComments.length)] : negativeComments[Math.floor(Math.random()*negativeComments.length)];
    addReview(stars, text);

    if(storage[id].count === 0) {
      delete storage[id];
    }
    renderBalance();
    renderStorage();
    checkLose();
  }

  // Обновление цены товара (через input)
  function updatePrice(id, newPrice) {
    if(!storage[id]) {
      // если товара нет на складе, создаём запись с count=0  
      storage[id] = {count:0, price: newPrice};
    } else {
      storage[id].price = newPrice;
    }
    renderStorage();
  }

  // Улучшение склада
  function upgradeStorage() {
    if(balance < upgradePrice) {
      alert(`Недостаточно монет. Нужно ${upgradePrice}.`);
      return;
    }
    balance -= upgradePrice;
    storageCapacity += 10;
    upgradePrice += 100;

    renderBalance();
    renderStorageCapacity();
    renderUpgradePrice();
  }

  // --- Обработчики ---
  startBtn.onclick = () => {
    const name = shopNameInput.value.trim();
    if(name.length === 0) {
      alert('Введите название магазина');
      return;
    }
    shopName = name;
    shopNameElem.textContent = shopName;
    startScreen.style.display = 'none';
    gameScreen.style.display = 'block';
    renderProducts();
    renderStorage();
    renderBalance();
    renderStorageCapacity();
    renderUpgradePrice();
    renderReviews();
    ratingValueElem.textContent = '—';
  };

  upgradeStorageBtn.onclick = upgradeStorage;

  productsElem.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const id = e.target.getAttribute('data-id');
      buyProduct(id);
    }
  });

  storageElem.addEventListener('click', e => {
    if(e.target.tagName === 'BUTTON') {
      const id = e.target.getAttribute('data-id');
      sellProduct(id);
    }
  });

  productsElem.addEventListener('change', e => {
    if(e.target.tagName === 'INPUT' && e.target.hasAttribute('data-id')) {
      const id = e.target.getAttribute('data-id');
      let val = parseInt(e.target.value);
      if(isNaN(val)) val = 50;
      if(val < 10) val = 10;
      if(val > 50) val = 50;
      e.target.value = val;
      updatePrice(id, val);
    }
  });
})();
</script>

</body>
  </html>
